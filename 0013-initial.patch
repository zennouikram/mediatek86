From a38821b773b383168132862abd9dc509b0b3a201 Mon Sep 17 00:00:00 2001
From: florent Richard <florent.r08@live.fr>
Date: Wed, 28 Apr 2021 15:48:01 +0200
Subject: [PATCH] =?UTF-8?q?Ajout=20de=20la=20fonctionnalit=C3=A9=20pour=20?=
 =?UTF-8?q?se=20connecter=20=C3=A0=20l'application?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 MediaTek86/controle/Controle.cs        | 31 ++++++++++++++++++++++--
 MediaTek86/dal/AccesDonnees.cs         | 27 +++++++++++++++++++++
 MediaTek86/vue/SeConnecter.Designer.cs |  2 ++
 MediaTek86/vue/SeConnecter.cs          | 33 +++++++++++++++++++++++---
 4 files changed, 88 insertions(+), 5 deletions(-)

diff --git a/MediaTek86/controle/Controle.cs b/MediaTek86/controle/Controle.cs
index dee1273..3a1a12d 100644
--- a/MediaTek86/controle/Controle.cs
+++ b/MediaTek86/controle/Controle.cs
@@ -15,6 +15,11 @@ namespace MediaTek86.controle
     /// </summary>
     public class Controle
     {
+        /// <summary>
+        /// instance de frmSeConnecter
+        /// </summary>
+        private frmSeConnecter frmSeConnecter;
+
         /// <summary>
         /// instance de frmListePersonnel
         /// </summary>
@@ -45,8 +50,30 @@ namespace MediaTek86.controle
         /// </summary>
         public Controle()
         {
-            frmListePersonnel = new frmListePersonnel(this);
-            frmListePersonnel.ShowDialog();
+            frmSeConnecter = new frmSeConnecter(this);
+            frmSeConnecter.ShowDialog();
+        }
+
+        /// <summary>
+        /// Demande la vérification de l'authentification
+        /// Si correct, alors ouvre la fenêtre principale
+        /// </summary>
+        /// <param name="login"></param>
+        /// <param name="pwd"></param>
+        /// <returns></returns>
+        public Boolean ControleAuthentification(string login, string pwd)
+        {
+            if (AccesDonnees.ControleAuthentification(login, pwd))
+            {
+                frmSeConnecter.Hide();
+                frmListePersonnel = new frmListePersonnel(this);
+                frmListePersonnel.ShowDialog();
+                return true;
+            }
+            else
+            {
+                return false;
+            }
         }
 
         /// <summary>
diff --git a/MediaTek86/dal/AccesDonnees.cs b/MediaTek86/dal/AccesDonnees.cs
index af3386e..e5178e8 100644
--- a/MediaTek86/dal/AccesDonnees.cs
+++ b/MediaTek86/dal/AccesDonnees.cs
@@ -16,6 +16,33 @@ namespace MediaTek86.dal
         /// /// </summary>
         private static string connectionString = "server=localhost;user id=admin;password=wHIwAcI3DijYBRvO;database=mediatek86;SslMode=none";
 
+        /// <summary>
+        /// Controle si l'utillisateur a le droit de se connecter
+        /// </summary>
+        /// <param name="login"></param>
+        /// <param name="pwd"></param>
+        /// <returns></returns>
+        public static Boolean ControleAuthentification(string login, string pwd)
+        {
+            string req = "select * from responsable r ";
+            req += "where r.login=@login and r.pwd=SHA2(@pwd, 256)";
+            Dictionary<string, object> parameters = new Dictionary<string, object>();
+            parameters.Add("@login", login);
+            parameters.Add("@pwd", pwd);
+            ConnexionBDD curs = ConnexionBDD.GetInstance(connectionString);
+            curs.ReqSelect(req, parameters);
+            if (curs.Read())
+            {
+                curs.Close();
+                return true;
+            }
+            else
+            {
+                curs.Close();
+                return false;
+            }
+        }
+
         /// <summary>
         /// Récupère et retourne le personnel provenant de la BDD
         /// </summary>
diff --git a/MediaTek86/vue/SeConnecter.Designer.cs b/MediaTek86/vue/SeConnecter.Designer.cs
index 3afa522..d4044f2 100644
--- a/MediaTek86/vue/SeConnecter.Designer.cs
+++ b/MediaTek86/vue/SeConnecter.Designer.cs
@@ -64,6 +64,7 @@
             // 
             this.txtMotDePasse.Location = new System.Drawing.Point(109, 51);
             this.txtMotDePasse.Name = "txtMotDePasse";
+            this.txtMotDePasse.PasswordChar = '*';
             this.txtMotDePasse.Size = new System.Drawing.Size(100, 20);
             this.txtMotDePasse.TabIndex = 3;
             // 
@@ -75,6 +76,7 @@
             this.btnSeConnecter.TabIndex = 4;
             this.btnSeConnecter.Text = "Se Connecter";
             this.btnSeConnecter.UseVisualStyleBackColor = true;
+            this.btnSeConnecter.Click += new System.EventHandler(this.btnSeConnecter_Click);
             // 
             // frmSeConnecter
             // 
diff --git a/MediaTek86/vue/SeConnecter.cs b/MediaTek86/vue/SeConnecter.cs
index b29a273..3f6c20d 100644
--- a/MediaTek86/vue/SeConnecter.cs
+++ b/MediaTek86/vue/SeConnecter.cs
@@ -1,4 +1,4 @@
-﻿using MediaTek86.modele;
+﻿using MediaTek86.controle;
 using System;
 using System.Collections.Generic;
 using System.ComponentModel;
@@ -13,15 +13,42 @@ namespace MediaTek86.vue
 {
     public partial class frmSeConnecter : Form
     {
+        /// <summary>
+        /// instance du controleur
+        /// </summary>
+        private Controle controle;
+
         /// <summary>
         /// Initialisation des composants graphiques
         /// Récupération du controleur
         /// </summary>
-        public frmSeConnecter()
+        public frmSeConnecter(Controle controle)
         {
             InitializeComponent();
+            this.controle = controle;
         }
 
-
+        /// <summary>
+        /// Permet de se connecter à l'application
+        /// </summary>
+        /// <param name="sender"></param>
+        /// <param name="e"></param>
+        private void btnSeConnecter_Click(object sender, EventArgs e)
+        {
+            if (!txtLogin.Text.Equals("") && !txtMotDePasse.Text.Equals(""))
+            {
+                if (!controle.ControleAuthentification(txtLogin.Text, txtMotDePasse.Text))
+                {
+                    MessageBox.Show("Authentification incorrecte ou vous n'êtes pas admin", "Alerte");
+                    txtLogin.Text = "";
+                    txtMotDePasse.Text = "";
+                    txtLogin.Focus();
+                }
+            }
+            else
+            {
+                MessageBox.Show("Tous les champs doivent être remplis.", "Information");
+            }
+        }
     }
 }
-- 
2.49.0.windows.1

